<?php
// CONFIG DATABASE
$host = "localhost";
$db = "NOME_DATABASE";
$user = "USER_DB";
$pass = "PASSWORD_DB";

$conn = new mysqli($host, $user, $pass, $db);
if($conn->connect_error) die("Connessione fallita: ".$conn->connect_error);

// SALVATAGGIO PUNTEGGIO
if(isset($_POST['name']) && isset($_POST['score'])){
    $name = $conn->real_escape_string($_POST['name']);
    $score = (int)$_POST['score'];
    $conn->query("INSERT INTO snake_scores (name, score) VALUES ('$name', $score)");
    echo "Punteggio salvato!";
    exit;
}

// RECUPERA CLASSIFICA
$highscores = $conn->query("SELECT name, score FROM snake_scores ORDER BY score DESC LIMIT 10");

?>
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Snake Game</title>
<style>
body { font-family: sans-serif; text-align: center; }
canvas { background: #000; display: block; margin: 20px auto; }
input, button { margin: 5px; padding: 5px; }
table { margin: 20px auto; border-collapse: collapse; }
td, th { padding: 5px 10px; border: 1px solid #ccc; }
</style>
</head>
<body>
<h1>Snake Game</h1>
<canvas id="gameCanvas" width="400" height="400"></canvas>

<form id="scoreForm">
  <input type="text" id="playerName" placeholder="Nome" required>
  <button type="submit">Salva Punteggio</button>
</form>

<h2>Classifica Top 10</h2>
<table>
<tr><th>Nome</th><th>Punteggio</th></tr>
<?php while($row = $highscores->fetch_assoc()): ?>
<tr><td><?php echo htmlspecialchars($row['name']); ?></td><td><?php echo $row['score']; ?></td></tr>
<?php endwhile; ?>
</table>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let box = 20;
let snake = [{x: 9*box, y: 10*box}];
let direction = "RIGHT";
let food = { x: Math.floor(Math.random()*20)*box, y: Math.floor(Math.random()*20)*box };
let score = 0;

document.addEventListener("keydown", e=>{
  if(e.keyCode==37 && direction!="RIGHT") direction="LEFT";
  if(e.keyCode==38 && direction!="DOWN") direction="UP";
  if(e.keyCode==39 && direction!="LEFT") direction="RIGHT";
  if(e.keyCode==40 && direction!="UP") direction="DOWN";
});

function draw(){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  for(let i=0;i<snake.length;i++){
    ctx.fillStyle = i==0?"lime":"green";
    ctx.fillRect(snake[i].x, snake[i].y, box, box);
  }

  ctx.fillStyle="red";
  ctx.fillRect(food.x, food.y, box, box);

  let snakeX = snake[0].x;
  let snakeY = snake[0].y;

  if(direction=="LEFT") snakeX-=box;
  if(direction=="UP") snakeY-=box;
  if(direction=="RIGHT") snakeX+=box;
  if(direction=="DOWN") snakeY+=box;

  if(snakeX==food.x && snakeY==food.y){
    score++;
    food = { x: Math.floor(Math.random()*20)*box, y: Math.floor(Math.random()*20)*box };
  } else snake.pop();

  let newHead = {x: snakeX, y: snakeY};

  if(snakeX<0 || snakeX>=canvas.width || snakeY<0 || snakeY>=canvas.height || collision(newHead,snake)){
    clearInterval(game);
    alert("Game Over! Punteggio: "+score);
  }

  snake.unshift(newHead);
}

function collision(head,array){
  for(let i=0;i<array.length;i++) if(head.x==array[i].x && head.y==array[i].y) return true;
  return false;
}

let game = setInterval(draw,100);

document.getElementById('scoreForm').addEventListener('submit', function(e){
  e.preventDefault();
  let name = document.getElementById('playerName').value;
  fetch('', {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body: `name=${encodeURIComponent(name)}&score=${score}`
  }).then(r=>r.text()).then(data=>{
    alert(data);
    window.location.reload();
  });
});
</script>
</body>
</html>